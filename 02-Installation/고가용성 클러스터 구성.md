# ê³ ê°€ìš©ì„± í´ëŸ¬ìŠ¤í„° êµ¬ì„±

## ğŸ¯ ê°œìš”

ì˜¨í”„ë ˜ í™˜ê²½ì—ì„œ ë‹¨ì¼ ì¥ì• ì ì„ ì œê±°í•˜ê³  ë†’ì€ ê°€ìš©ì„±ì„ ë³´ì¥í•˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° êµ¬ì„± ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤. ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œ ê²€ì¦ëœ HA íŒ¨í„´ì„ ì œì‹œí•©ë‹ˆë‹¤.

## ğŸ—ï¸ HA ì•„í‚¤í…ì²˜ ì„¤ê³„

### ê¶Œì¥ HA êµ¬ì„±

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Load Balancer  â”‚
                    â”‚   (HAProxy)     â”‚
                    â”‚  VIP: 10.1.1.100â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚   Master 1  â”‚   â”‚   Master 2  â”‚   â”‚   Master 3  â”‚
    â”‚ 10.1.1.101  â”‚   â”‚ 10.1.1.102  â”‚   â”‚ 10.1.1.103  â”‚
    â”‚             â”‚   â”‚             â”‚   â”‚             â”‚
    â”‚ API Server  â”‚   â”‚ API Server  â”‚   â”‚ API Server  â”‚
    â”‚ Controller  â”‚   â”‚ Controller  â”‚   â”‚ Controller  â”‚
    â”‚ Scheduler   â”‚   â”‚ Scheduler   â”‚   â”‚ Scheduler   â”‚
    â”‚ etcd        â”‚   â”‚ etcd        â”‚   â”‚ etcd        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                 â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
 â”‚  Worker 1   â”‚      â”‚  Worker 2   â”‚      â”‚  Worker N   â”‚
 â”‚ 10.1.1.201  â”‚      â”‚ 10.1.1.202  â”‚      â”‚ 10.1.1.20N â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë„¤íŠ¸ì›Œí¬ ì„¤ê³„

```yaml
# ë„¤íŠ¸ì›Œí¬ ì„¸ê·¸ë¨¼íŠ¸ ê³„íš
ê´€ë¦¬ ë„¤íŠ¸ì›Œí¬: 10.1.1.0/24
  - ë¡œë“œë°¸ëŸ°ì„œ VIP: 10.1.1.100
  - ë§ˆìŠ¤í„° ë…¸ë“œ: 10.1.1.101-103
  - ì›Œì»¤ ë…¸ë“œ: 10.1.1.201-250

í´ëŸ¬ìŠ¤í„° ë„¤íŠ¸ì›Œí¬: 10.244.0.0/16 (Pod CIDR)
ì„œë¹„ìŠ¤ ë„¤íŠ¸ì›Œí¬: 10.96.0.0/12 (Service CIDR)

ìŠ¤í† ë¦¬ì§€ ë„¤íŠ¸ì›Œí¬: 10.2.1.0/24 (ì„ íƒì‚¬í•­)
  - ìŠ¤í† ë¦¬ì§€ ì„œë²„: 10.2.1.101-110
  - iSCSI/NFS ì „ìš©
```

## âš–ï¸ ë¡œë“œë°¸ëŸ°ì„œ êµ¬ì„±

### HAProxy ì„¤ì •

```bash
# HAProxy ì„¤ì¹˜ (ê° LB ë…¸ë“œì—ì„œ)
yum install -y haproxy keepalived

# HAProxy ì„¤ì • íŒŒì¼
cat > /etc/haproxy/haproxy.cfg << 'EOF'
global
    log         127.0.0.1:514 local0
    chroot      /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user        haproxy
    group       haproxy
    daemon

defaults
    mode                    tcp
    log                     global
    option                  tcplog
    option                  dontlognull
    option                  redispatch
    retries                 3
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout check           10s
    maxconn                 3000

# Statistics
frontend stats
    bind *:9000
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# Kubernetes API Server Frontend
frontend k8s-api
    bind 10.1.1.100:6443
    mode tcp
    option tcplog
    default_backend k8s-api-backend

# Kubernetes API Server Backend
backend k8s-api-backend
    mode tcp
    option tcplog
    option tcp-check
    balance roundrobin
    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
    
    server master1 10.1.1.101:6443 check
    server master2 10.1.1.102:6443 check
    server master3 10.1.1.103:6443 check

# HTTP Ingress Frontend (optional)
frontend ingress-http
    bind 10.1.1.100:80
    mode http
    option httplog
    default_backend ingress-http-backend

# HTTPS Ingress Frontend (optional)
frontend ingress-https
    bind 10.1.1.100:443
    mode tcp
    option tcplog
    default_backend ingress-https-backend

# HTTP Ingress Backend
backend ingress-http-backend
    mode http
    option httplog
    balance roundrobin
    option httpchk GET /healthz
    
    server worker1 10.1.1.201:30080 check
    server worker2 10.1.1.202:30080 check
    server worker3 10.1.1.203:30080 check

# HTTPS Ingress Backend
backend ingress-https-backend
    mode tcp
    option tcplog
    balance roundrobin
    
    server worker1 10.1.1.201:30443 check
    server worker2 10.1.1.202:30443 check
    server worker3 10.1.1.203:30443 check
EOF
```

### Keepalived ì„¤ì • (VIP ê´€ë¦¬)

```bash
# Keepalived ì„¤ì • (Primary LB)
cat > /etc/keepalived/keepalived.conf << 'EOF'
vrrp_script chk_haproxy {
    script "/bin/kill -0 `cat /var/run/haproxy.pid`"
    interval 2
    weight 2
    fall 3
    rise 2
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 110
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass mypassword
    }
    virtual_ipaddress {
        10.1.1.100
    }
    track_script {
        chk_haproxy
    }
}
EOF

# Keepalived ì„¤ì • (Backup LB) - priorityë¥¼ 100ìœ¼ë¡œ ì„¤ì •
# stateë¥¼ BACKUPìœ¼ë¡œ ë³€ê²½
```

### ë¡œë“œë°¸ëŸ°ì„œ ì„œë¹„ìŠ¤ ì‹œì‘

```bash
# ì„œë¹„ìŠ¤ í™œì„±í™” ë° ì‹œì‘
systemctl enable haproxy keepalived
systemctl start haproxy keepalived

# ìƒíƒœ í™•ì¸
systemctl status haproxy keepalived

# VIP í™•ì¸
ip addr show | grep 10.1.1.100

# HAProxy í†µê³„ í™•ì¸
curl http://10.1.1.100:9000/stats
```

## ğŸ›ï¸ etcd í´ëŸ¬ìŠ¤í„° ì„¤ì •

### etcd í´ëŸ¬ìŠ¤í„° êµ¬ì„±

```bash
# ê° ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ etcd í´ëŸ¬ìŠ¤í„° ì„¤ì •
# kubeadm-config.yamlì— etcd ì„¤ì • í¬í•¨

cat > /root/kubeadm-config.yaml << 'EOF'
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 10.1.1.101  # ê° ë…¸ë“œë³„ë¡œ ë³€ê²½
  bindPort: 6443
nodeRegistration:
  criSocket: unix:///var/run/containerd/containerd.sock
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: v1.28.0
clusterName: ha-cluster
controlPlaneEndpoint: "10.1.1.100:6443"  # LB VIP
networking:
  serviceSubnet: "10.96.0.0/12"
  podSubnet: "10.244.0.0/16"
  dnsDomain: "cluster.local"
apiServer:
  advertiseAddress: 10.1.1.101  # ê° ë…¸ë“œë³„ë¡œ ë³€ê²½
  certSANs:
  - "10.1.1.100"  # LB VIP
  - "10.1.1.101"  # Master 1
  - "10.1.1.102"  # Master 2
  - "10.1.1.103"  # Master 3
  - "k8s-api.company.local"
  extraArgs:
    audit-log-maxage: "30"
    audit-log-maxbackup: "3"
    audit-log-maxsize: "100"
    audit-log-path: "/var/log/audit.log"
etcd:
  local:
    serverCertSANs:
    - "10.1.1.101"
    - "10.1.1.102" 
    - "10.1.1.103"
    peerCertSANs:
    - "10.1.1.101"
    - "10.1.1.102"
    - "10.1.1.103"
    extraArgs:
      initial-cluster: "master1=https://10.1.1.101:2380,master2=https://10.1.1.102:2380,master3=https://10.1.1.103:2380"
      initial-cluster-state: "new"
      name: "master1"  # ê° ë…¸ë“œë³„ë¡œ ë³€ê²½
      listen-peer-urls: "https://10.1.1.101:2380"  # ê° ë…¸ë“œë³„ë¡œ ë³€ê²½
      listen-client-urls: "https://10.1.1.101:2379,https://127.0.0.1:2379"  # ê° ë…¸ë“œë³„ë¡œ ë³€ê²½
      advertise-client-urls: "https://10.1.1.101:2379"  # ê° ë…¸ë“œë³„ë¡œ ë³€ê²½
      initial-advertise-peer-urls: "https://10.1.1.101:2380"  # ê° ë…¸ë“œë³„ë¡œ ë³€ê²½
EOF
```

### ì²« ë²ˆì§¸ ë§ˆìŠ¤í„° ë…¸ë“œ ì´ˆê¸°í™”

```bash
# ì²« ë²ˆì§¸ ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”
kubeadm init --config=/root/kubeadm-config.yaml --upload-certs

# ì¶œë ¥ì—ì„œ join ëª…ë ¹ì–´ ì €ì¥
# ë§ˆìŠ¤í„° ë…¸ë“œ join ëª…ë ¹ì–´:
kubeadm join 10.1.1.100:6443 --token <token> \
    --discovery-token-ca-cert-hash sha256:<hash> \
    --control-plane --certificate-key <cert-key>

# ì›Œì»¤ ë…¸ë“œ join ëª…ë ¹ì–´:
kubeadm join 10.1.1.100:6443 --token <token> \
    --discovery-token-ca-cert-hash sha256:<hash>
```

### ì¶”ê°€ ë§ˆìŠ¤í„° ë…¸ë“œ ì¡°ì¸

```bash
# ë‘ ë²ˆì§¸, ì„¸ ë²ˆì§¸ ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ì‹¤í–‰
# kubeadm-config.yaml íŒŒì¼ì„ ê° ë…¸ë“œì˜ IPì— ë§ê²Œ ìˆ˜ì • í›„

kubeadm join 10.1.1.100:6443 --token <token> \
    --discovery-token-ca-cert-hash sha256:<hash> \
    --control-plane --certificate-key <cert-key>

# kubectl ì„¤ì •
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

## ğŸ”§ HA ê²€ì¦ ë° í…ŒìŠ¤íŠ¸

### í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸

```bash
# ë…¸ë“œ ìƒíƒœ í™•ì¸
kubectl get nodes -o wide

# etcd í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸
kubectl exec -n kube-system etcd-master1 -- etcdctl \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  member list

# API ì„œë²„ ìƒíƒœ í™•ì¸
kubectl get componentstatuses
```

### ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

```bash
# 1. ë§ˆìŠ¤í„° ë…¸ë“œ 1ëŒ€ ì¤‘ë‹¨ í…ŒìŠ¤íŠ¸
sudo systemctl stop kubelet
# í´ëŸ¬ìŠ¤í„° API ì ‘ê·¼ì„± í™•ì¸
kubectl get nodes

# 2. etcd 1ëŒ€ ì¤‘ë‹¨ í…ŒìŠ¤íŠ¸
sudo systemctl stop etcd
# í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸
kubectl get pods -A

# 3. ë¡œë“œë°¸ëŸ°ì„œ failover í…ŒìŠ¤íŠ¸
sudo systemctl stop haproxy  # Primary LBì—ì„œ
# VIPê°€ Backup LBë¡œ ì´ë™í•˜ëŠ”ì§€ í™•ì¸
```

### ìë™ ë³µêµ¬ í™•ì¸

```bash
# ì„œë¹„ìŠ¤ ì¬ì‹œì‘ í›„ ìë™ ë³µêµ¬ í™•ì¸
sudo systemctl start kubelet
sudo systemctl start etcd
sudo systemctl start haproxy

# í´ëŸ¬ìŠ¤í„° ìƒíƒœ ì •ìƒí™” í™•ì¸
kubectl get nodes
kubectl get pods -A
```

## ğŸ“Š HA ëª¨ë‹ˆí„°ë§

### etcd ëª¨ë‹ˆí„°ë§

```yaml
# etcd-monitoring.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: etcd-monitoring
  namespace: monitoring
spec:
  selector:
    matchLabels:
      component: etcd
  endpoints:
  - port: http-metrics
    interval: 30s
    scheme: https
    tlsConfig:
      caFile: /etc/prometheus/secrets/etcd-certs/ca.crt
      certFile: /etc/prometheus/secrets/etcd-certs/client.crt
      keyFile: /etc/prometheus/secrets/etcd-certs/client.key
      serverName: localhost
      insecureSkipVerify: false

---
# etcd ì•Œë¦¼ ê·œì¹™
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: etcd-alerts
  namespace: monitoring
spec:
  groups:
  - name: etcd
    rules:
    - alert: EtcdMemberDown
      expr: up{job="etcd"} == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "etcd member is down"
        description: "etcd member {{ $labels.instance }} is down for more than 5 minutes."
        
    - alert: EtcdHighCommitDurations
      expr: histogram_quantile(0.99, sum(rate(etcd_disk_backend_commit_duration_seconds_bucket[5m])) by (instance, le)) > 0.25
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "etcd high commit durations"
        description: "etcd commit durations are high on {{ $labels.instance }}"
```

### HAProxy ëª¨ë‹ˆí„°ë§

```bash
# HAProxy Exporter ì„¤ì¹˜
docker run -d \
  --name haproxy-exporter \
  -p 9101:9101 \
  quay.io/prometheus/haproxy-exporter:latest \
  --haproxy.scrape-uri="http://10.1.1.100:9000/stats;csv"

# Prometheusì—ì„œ HAProxy ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì„¤ì •
# prometheus.ymlì— ì¶”ê°€:
# - job_name: 'haproxy'
#   static_configs:
#   - targets: ['10.1.1.100:9101']
```

## ğŸ› ï¸ HA ìš´ì˜ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### ì •ê¸° ë°±ì—… ì „ëµ

```bash
#!/bin/bash
# ha-backup.sh - HA í´ëŸ¬ìŠ¤í„° ë°±ì—… ìŠ¤í¬ë¦½íŠ¸

BACKUP_DIR="/var/backups/ha-cluster"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"

# etcd ë°±ì—… (ëª¨ë“  ë§ˆìŠ¤í„°ì—ì„œ)
for master in master1 master2 master3; do
    echo "Backing up etcd from $master..."
    ssh "$master" "
        ETCDCTL_API=3 etcdctl snapshot save /tmp/etcd-snapshot-$DATE.db \
          --endpoints=https://127.0.0.1:2379 \
          --cacert=/etc/kubernetes/pki/etcd/ca.crt \
          --cert=/etc/kubernetes/pki/etcd/server.crt \
          --key=/etc/kubernetes/pki/etcd/server.key
    "
    scp "$master:/tmp/etcd-snapshot-$DATE.db" "$BACKUP_DIR/etcd-$master-$DATE.db"
    ssh "$master" "rm /tmp/etcd-snapshot-$DATE.db"
done

# ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì • ë°±ì—…
kubectl get all --all-namespaces -o yaml > "$BACKUP_DIR/k8s-resources-$DATE.yaml"

# HAProxy ì„¤ì • ë°±ì—…
for lb in lb1 lb2; do
    scp "$lb:/etc/haproxy/haproxy.cfg" "$BACKUP_DIR/haproxy-$lb-$DATE.cfg"
    scp "$lb:/etc/keepalived/keepalived.conf" "$BACKUP_DIR/keepalived-$lb-$DATE.conf"
done

echo "HA cluster backup completed: $BACKUP_DIR"
```

### ì—…ê·¸ë ˆì´ë“œ ì ˆì°¨

```bash
#!/bin/bash
# ha-upgrade.sh - HA í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ ìŠ¤í¬ë¦½íŠ¸

KUBE_VERSION="v1.28.1"

echo "Starting HA cluster upgrade to $KUBE_VERSION..."

# 1. ë°±ì—… ì‹¤í–‰
./ha-backup.sh

# 2. ì²« ë²ˆì§¸ ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ
echo "Upgrading first master node..."
kubectl drain master1 --ignore-daemonsets
ssh master1 "
    sudo kubeadm upgrade plan
    sudo kubeadm upgrade apply $KUBE_VERSION -y
    sudo yum update -y kubelet kubeadm kubectl
    sudo systemctl daemon-reload
    sudo systemctl restart kubelet
"
kubectl uncordon master1

# 3. ë‚˜ë¨¸ì§€ ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ
for master in master2 master3; do
    echo "Upgrading $master..."
    kubectl drain "$master" --ignore-daemonsets
    ssh "$master" "
        sudo kubeadm upgrade node
        sudo yum update -y kubelet kubeadm kubectl
        sudo systemctl daemon-reload
        sudo systemctl restart kubelet
    "
    kubectl uncordon "$master"
done

# 4. ì›Œì»¤ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ (ìˆœì°¨ì ìœ¼ë¡œ)
for worker in worker1 worker2 worker3; do
    echo "Upgrading $worker..."
    kubectl drain "$worker" --ignore-daemonsets --delete-emptydir-data
    ssh "$worker" "
        sudo yum update -y kubelet kubeadm kubectl
        sudo systemctl daemon-reload
        sudo systemctl restart kubelet
    "
    kubectl uncordon "$worker"
done

echo "HA cluster upgrade completed!"
```

### ì¥ì•  ë³µêµ¬ ì ˆì°¨

```bash
#!/bin/bash
# disaster-recovery.sh

recover_etcd_member() {
    local failed_member=$1
    
    echo "Recovering etcd member: $failed_member"
    
    # 1. ì‹¤íŒ¨í•œ ë©¤ë²„ ì œê±°
    kubectl exec -n kube-system etcd-master1 -- etcdctl \
      --endpoints=https://127.0.0.1:2379 \
      --cacert=/etc/kubernetes/pki/etcd/ca.crt \
      --cert=/etc/kubernetes/pki/etcd/server.crt \
      --key=/etc/kubernetes/pki/etcd/server.key \
      member remove "$failed_member"
    
    # 2. ìƒˆ ë©¤ë²„ ì¶”ê°€
    kubectl exec -n kube-system etcd-master1 -- etcdctl \
      --endpoints=https://127.0.0.1:2379 \
      --cacert=/etc/kubernetes/pki/etcd/ca.crt \
      --cert=/etc/kubernetes/pki/etcd/server.crt \
      --key=/etc/kubernetes/pki/etcd/server.key \
      member add "$failed_member" --peer-urls="https://$failed_member:2380"
    
    # 3. ë…¸ë“œì—ì„œ etcd ì¬ì‹œì‘
    ssh "$failed_member" "
        sudo systemctl stop etcd
        sudo rm -rf /var/lib/etcd/member
        sudo systemctl start etcd
    "
    
    echo "etcd member recovery completed"
}

# ì‚¬ìš© ì˜ˆ: recover_etcd_member "10.1.1.102"
```

## ğŸš¨ HA íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ì¼ë°˜ì ì¸ ë¬¸ì œë“¤

#### 1. Split-brain í˜„ìƒ
```bash
# etcd í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸
kubectl exec -n kube-system etcd-master1 -- etcdctl \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  endpoint status --write-out=table

# ë„¤íŠ¸ì›Œí¬ ë¶„í•  í™•ì¸
ping -c 3 10.1.1.102
ping -c 3 10.1.1.103
```

#### 2. ë¡œë“œë°¸ëŸ°ì„œ VIP ë¬¸ì œ
```bash
# VIP ìƒíƒœ í™•ì¸
ip addr show | grep 10.1.1.100

# Keepalived ë¡œê·¸ í™•ì¸
journalctl -u keepalived -f

# HAProxy ë°±ì—”ë“œ ìƒíƒœ í™•ì¸
curl http://10.1.1.100:9000/stats
```

#### 3. ì¸ì¦ì„œ ë¬¸ì œ
```bash
# ì¸ì¦ì„œ ë§Œë£Œ í™•ì¸
kubeadm certs check-expiration

# ì¸ì¦ì„œ ê°±ì‹ 
kubeadm certs renew all
systemctl restart kubelet
```

---

> ğŸ’¡ **ì‹¤ì „ ê²½í—˜**: HA êµ¬ì„±ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ ë„¤íŠ¸ì›Œí¬ ì•ˆì •ì„±ì…ë‹ˆë‹¤. íŠ¹íˆ etcd ê°„ í†µì‹ ì´ ë¶ˆì•ˆì •í•˜ë©´ ì „ì²´ í´ëŸ¬ìŠ¤í„°ê°€ ì˜í–¥ì„ ë°›ìœ¼ë¯€ë¡œ, ì „ìš© ë„¤íŠ¸ì›Œí¬ë‚˜ ë³¸ë”©ì„ ê³ ë ¤í•˜ì„¸ìš”. ì •ê¸°ì ì¸ ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ë„ í•„ìˆ˜ì…ë‹ˆë‹¤.

íƒœê·¸: #ha #high-availability #etcd #loadbalancer #haproxy #onprem