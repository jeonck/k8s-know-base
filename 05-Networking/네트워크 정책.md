# ë„¤íŠ¸ì›Œí¬ ì •ì±…

## ğŸ¯ ê°œìš”

ì¿ ë²„ë„¤í‹°ìŠ¤ NetworkPolicyë¥¼ í™œìš©í•œ ë§ˆì´í¬ë¡œ ì„¸ê·¸ë©˜í…Œì´ì…˜ êµ¬í˜„ê³¼ ì˜¨í”„ë ˜ í™˜ê²½ì—ì„œì˜ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ê°•í™” ì „ëµì„ ë‹¤ë£¹ë‹ˆë‹¤. Zero Trust ë„¤íŠ¸ì›Œí¬ ëª¨ë¸ êµ¬í˜„ê³¼ ì‹¤ì „ ì •ì±… ì„¤ê³„ íŒ¨í„´ì„ í¬í•¨í•©ë‹ˆë‹¤.

## ğŸ”’ NetworkPolicy ê¸°ë³¸ ê°œë…

### NetworkPolicy ì‘ë™ ì›ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Namespace A                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    NetworkPolicy    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Pod A1  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Pod A2  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     (Allow)         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                                  â”‚      â”‚
â”‚       â”‚ (Deny by Policy)                 â”‚      â”‚
â”‚       â–¼                                  â–¼      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                  â”‚       
        â”‚ (Default Allow)                  â”‚       
        â–¼                                  â–¼       
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Namespace B                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Pod B1  â”‚                    â”‚  Pod B2  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ê¸°ë³¸ NetworkPolicy êµ¬ì¡°

```yaml
# basic-network-policy.yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: basic-network-policy
  namespace: production
spec:
  # ì •ì±…ì´ ì ìš©ë  Pod ì„ íƒ
  podSelector:
    matchLabels:
      app: web-app
      tier: frontend
  
  # ì •ì±… ìœ í˜• (Ingress, Egress ë˜ëŠ” ë‘˜ ë‹¤)
  policyTypes:
  - Ingress
  - Egress
  
  # ì¸ë°”ìš´ë“œ íŠ¸ë˜í”½ ê·œì¹™
  ingress:
  - from:
    # íŠ¹ì • Podì—ì„œì˜ íŠ¸ë˜í”½ í—ˆìš©
    - podSelector:
        matchLabels:
          app: api-gateway
    # íŠ¹ì • ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œì˜ íŠ¸ë˜í”½ í—ˆìš©
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    # íŠ¹ì • IP ë²”ìœ„ì—ì„œì˜ íŠ¸ë˜í”½ í—ˆìš©
    - ipBlock:
        cidr: 192.168.1.0/24
        except:
        - 192.168.1.5/32
    # í—ˆìš©í•  í¬íŠ¸
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 8443
  
  # ì•„ì›ƒë°”ìš´ë“œ íŠ¸ë˜í”½ ê·œì¹™
  egress:
  - to:
    # ë°ì´í„°ë² ì´ìŠ¤ Podë¡œì˜ íŠ¸ë˜í”½ í—ˆìš©
    - podSelector:
        matchLabels:
          app: mysql
          tier: database
    ports:
    - protocol: TCP
      port: 3306
  - to:
    # ì™¸ë¶€ DNS ì„œë²„ ì ‘ê·¼ í—ˆìš©
    - ipBlock:
        cidr: 8.8.8.8/32
    - ipBlock:
        cidr: 1.1.1.1/32
    ports:
    - protocol: UDP
      port: 53
```

## ğŸ›¡ï¸ Zero Trust ë„¤íŠ¸ì›Œí¬ ëª¨ë¸

### Default Deny ì •ì±…

```yaml
# default-deny-policies.yaml
---
# ëª¨ë“  Ingress íŠ¸ë˜í”½ ì°¨ë‹¨
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: production
spec:
  podSelector: {}  # ëª¨ë“  Podì— ì ìš©
  policyTypes:
  - Ingress

---
# ëª¨ë“  Egress íŠ¸ë˜í”½ ì°¨ë‹¨
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: production
spec:
  podSelector: {}  # ëª¨ë“  Podì— ì ìš©
  policyTypes:
  - Egress

---
# ëª¨ë“  íŠ¸ë˜í”½ ì°¨ë‹¨ (Ingress + Egress)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# DNS í•´ê²° í—ˆìš© (í•„ìˆ˜)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  # í´ëŸ¬ìŠ¤í„° DNS í—ˆìš©
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    - podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # ì™¸ë¶€ DNS í—ˆìš©
  - to:
    - ipBlock:
        cidr: 8.8.8.8/32
    - ipBlock:
        cidr: 1.1.1.1/32
    ports:
    - protocol: UDP
      port: 53
```

## ğŸ—ï¸ 3-Tier ì• í”Œë¦¬ì¼€ì´ì…˜ ë„¤íŠ¸ì›Œí¬ ì •ì±…

### Frontend ê³„ì¸µ ì •ì±…

```yaml
# frontend-network-policies.yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-network-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: frontend
  policyTypes:
  - Ingress
  - Egress
  
  # Frontend ì¸ë°”ìš´ë“œ íŠ¸ë˜í”½
  ingress:
  # Ingress Controllerì—ì„œì˜ íŠ¸ë˜í”½ í—ˆìš©
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 8443
  
  # ë¡œë“œë°¸ëŸ°ì„œì—ì„œì˜ ì§ì ‘ ì ‘ê·¼ í—ˆìš©
  - from:
    - ipBlock:
        cidr: 192.168.1.0/24  # ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬
    ports:
    - protocol: TCP
      port: 8080
  
  # Frontend ì•„ì›ƒë°”ìš´ë“œ íŠ¸ë˜í”½
  egress:
  # Backend API ì„œë²„ ì ‘ê·¼
  - to:
    - podSelector:
        matchLabels:
          tier: backend
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090  # ë©”íŠ¸ë¦­
  
  # ì™¸ë¶€ CDN/ì •ì  ë¦¬ì†ŒìŠ¤ ì ‘ê·¼
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        - 10.0.0.0/8
        - 192.168.0.0/16
        - 172.16.0.0/12
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443

---
# Frontend ë‚´ë¶€ í†µì‹  í—ˆìš©
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-internal-communication
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: frontend
  policyTypes:
  - Ingress
  ingress:
  # ê°™ì€ tier ë‚´ Pod ê°„ í†µì‹  í—ˆìš© (ì„¸ì…˜ ê³µìœ  ë“±)
  - from:
    - podSelector:
        matchLabels:
          tier: frontend
    ports:
    - protocol: TCP
      port: 8080
```

### Backend ê³„ì¸µ ì •ì±…

```yaml
# backend-network-policies.yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-network-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: backend
  policyTypes:
  - Ingress
  - Egress
  
  # Backend ì¸ë°”ìš´ë“œ íŠ¸ë˜í”½
  ingress:
  # Frontendì—ì„œì˜ íŠ¸ë˜í”½ë§Œ í—ˆìš©
  - from:
    - podSelector:
        matchLabels:
          tier: frontend
    ports:
    - protocol: TCP
      port: 8080
  
  # ê´€ë¦¬ìš© ì ‘ê·¼ (íŠ¹ì • IPì—ì„œë§Œ)
  - from:
    - ipBlock:
        cidr: 192.168.1.100/32  # ê´€ë¦¬ì IP
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090  # ë©”íŠ¸ë¦­
  
  # Backend ì•„ì›ƒë°”ìš´ë“œ íŠ¸ë˜í”½
  egress:
  # ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼
  - to:
    - podSelector:
        matchLabels:
          tier: database
    ports:
    - protocol: TCP
      port: 3306  # MySQL
    - protocol: TCP
      port: 5432  # PostgreSQL
    - protocol: TCP
      port: 6379  # Redis
  
  # ì™¸ë¶€ API í˜¸ì¶œ
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        - 10.0.0.0/8
        - 192.168.0.0/16
        - 172.16.0.0/12
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
  
  # ë©”ì‹œì§€ í ì ‘ê·¼
  - to:
    - podSelector:
        matchLabels:
          app: rabbitmq
    ports:
    - protocol: TCP
      port: 5672
    - protocol: TCP
      port: 15672

---
# Backend ì„œë¹„ìŠ¤ ê°„ í†µì‹ 
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-service-mesh
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: backend
  policyTypes:
  - Ingress
  ingress:
  # ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ í†µì‹  í—ˆìš©
  - from:
    - podSelector:
        matchLabels:
          tier: backend
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090
```

### Database ê³„ì¸µ ì •ì±…

```yaml
# database-network-policies.yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: database-network-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: database
  policyTypes:
  - Ingress
  - Egress
  
  # Database ì¸ë°”ìš´ë“œ íŠ¸ë˜í”½
  ingress:
  # Backend tierì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©
  - from:
    - podSelector:
        matchLabels:
          tier: backend
    ports:
    - protocol: TCP
      port: 3306  # MySQL
    - protocol: TCP
      port: 5432  # PostgreSQL
  
  # DBA ê´€ë¦¬ìš© ì ‘ê·¼
  - from:
    - ipBlock:
        cidr: 192.168.1.100/32  # DBA IP
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 5432
  
  # ë°±ì—… ì„œë²„ ì ‘ê·¼
  - from:
    - podSelector:
        matchLabels:
          app: backup-agent
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 5432
  
  # Database ì•„ì›ƒë°”ìš´ë“œ íŠ¸ë˜í”½
  egress:
  # ë°ì´í„°ë² ì´ìŠ¤ ë³µì œë¥¼ ìœ„í•œ ì™¸ë¶€ ì ‘ê·¼
  - to:
    - ipBlock:
        cidr: 192.168.2.0/24  # ë°±ì—… ë„¤íŠ¸ì›Œí¬
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 5432
  
  # NTP ì„œë²„ ì ‘ê·¼ (ì‹œê°„ ë™ê¸°í™”)
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
    ports:
    - protocol: UDP
      port: 123

---
# ë°ì´í„°ë² ì´ìŠ¤ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ í†µì‹ 
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: database-cluster-communication
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: database
  policyTypes:
  - Ingress
  - Egress
  
  # í´ëŸ¬ìŠ¤í„° ë‚´ ë³µì œ í†µì‹ 
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: database
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 33060  # MySQL Group Replication
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 5433   # PostgreSQL ë³µì œ
  
  egress:
  - to:
    - podSelector:
        matchLabels:
          tier: database
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 33060
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 5433
```

## ğŸ”§ íŠ¹ìˆ˜ ëª©ì  ë„¤íŠ¸ì›Œí¬ ì •ì±…

### ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì •ì±…

```yaml
# monitoring-network-policies.yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus-network-policy
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
  - Ingress
  - Egress
  
  # Prometheus ì¸ë°”ìš´ë“œ
  ingress:
  # Grafanaì—ì„œì˜ ì ‘ê·¼
  - from:
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 9090
  
  # ê´€ë¦¬ì ì ‘ê·¼
  - from:
    - ipBlock:
        cidr: 192.168.1.0/24
    ports:
    - protocol: TCP
      port: 9090
  
  # Prometheus ì•„ì›ƒë°”ìš´ë“œ
  egress:
  # ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
  - to: []  # ëª¨ë“  ëŒ€ìƒ í—ˆìš©
    ports:
    - protocol: TCP
      port: 9090
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 2112
  
  # AlertManager ì ‘ê·¼
  - to:
    - podSelector:
        matchLabels:
          app: alertmanager
    ports:
    - protocol: TCP
      port: 9093

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grafana-network-policy
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app: grafana
  policyTypes:
  - Ingress
  - Egress
  
  # Grafana ì¸ë°”ìš´ë“œ
  ingress:
  # ì‚¬ìš©ì ì ‘ê·¼
  - from:
    - ipBlock:
        cidr: 192.168.1.0/24
    ports:
    - protocol: TCP
      port: 3000
  
  # Grafana ì•„ì›ƒë°”ìš´ë“œ
  egress:
  # Prometheus ë°ì´í„°ì†ŒìŠ¤ ì ‘ê·¼
  - to:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090
  
  # ì™¸ë¶€ ì•Œë¦¼ (Slack, Email)
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        - 10.0.0.0/8
        - 192.168.0.0/16
        - 172.16.0.0/12
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 587  # SMTP
```

### ê°œë°œ/ìŠ¤í…Œì´ì§• í™˜ê²½ ê²©ë¦¬

```yaml
# environment-isolation.yaml
---
# ê°œë°œ í™˜ê²½ ê²©ë¦¬
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: development-isolation
  namespace: development
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  
  # ê°œë°œ í™˜ê²½ ì¸ë°”ìš´ë“œ
  ingress:
  # ê°œë°œíŒ€ ë„¤íŠ¸ì›Œí¬ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©
  - from:
    - ipBlock:
        cidr: 192.168.10.0/24  # ê°œë°œíŒ€ ë„¤íŠ¸ì›Œí¬
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 3000
  
  # ê°™ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ í†µì‹  í—ˆìš©
  - from:
    - namespaceSelector:
        matchLabels:
          name: development
  
  # ê°œë°œ í™˜ê²½ ì•„ì›ƒë°”ìš´ë“œ
  egress:
  # ê°œë°œìš© ë°ì´í„°ë² ì´ìŠ¤ë§Œ ì ‘ê·¼
  - to:
    - ipBlock:
        cidr: 192.168.20.0/24  # ê°œë°œ DB ë„¤íŠ¸ì›Œí¬
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 5432
  
  # ì¸í„°ë„· ì ‘ê·¼ (íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë“±)
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        - 10.0.0.0/8
        - 192.168.1.0/24   # ìš´ì˜ ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨
        - 172.16.0.0/12
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443

---
# ìŠ¤í…Œì´ì§• í™˜ê²½ - ìš´ì˜ í™˜ê²½ê³¼ ìœ ì‚¬í•œ ì œí•œ
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: staging-isolation
  namespace: staging
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  
  # ìŠ¤í…Œì´ì§• ì¸ë°”ìš´ë“œ
  ingress:
  # QAíŒ€ê³¼ ê°œë°œíŒ€ ì ‘ê·¼
  - from:
    - ipBlock:
        cidr: 192.168.10.0/24  # ê°œë°œíŒ€
    - ipBlock:
        cidr: 192.168.11.0/24  # QAíŒ€
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 8080
  
  # ìŠ¤í…Œì´ì§• ì•„ì›ƒë°”ìš´ë“œ (ìš´ì˜ê³¼ ë™ì¼í•˜ê²Œ ì œí•œì )
  egress:
  # ìŠ¤í…Œì´ì§• ë°ì´í„°ë² ì´ìŠ¤ë§Œ ì ‘ê·¼
  - to:
    - ipBlock:
        cidr: 192.168.21.0/24  # ìŠ¤í…Œì´ì§• DB
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 5432
```

## ğŸš€ ê³ ê¸‰ ë„¤íŠ¸ì›Œí¬ ì •ì±… íŒ¨í„´

### ì‹œê°„ ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (CRD í™œìš©)

```yaml
# time-based-access.yaml
---
# ì—…ë¬´ ì‹œê°„ì—ë§Œ ê°œë°œ í™˜ê²½ ì ‘ê·¼ í—ˆìš©
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: business-hours-access
  namespace: development
  annotations:
    schedule.policy/start-time: "09:00"
    schedule.policy/end-time: "18:00"
    schedule.policy/timezone: "Asia/Seoul"
    schedule.policy/weekdays: "monday,tuesday,wednesday,thursday,friday"
spec:
  podSelector:
    matchLabels:
      environment: development
  policyTypes:
  - Ingress
  ingress:
  - from:
    - ipBlock:
        cidr: 192.168.10.0/24
    ports:
    - protocol: TCP
      port: 8080
```

### ë™ì  ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ ì •ì±…

```yaml
# service-discovery-policy.yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: service-mesh-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/part-of: microservices
  policyTypes:
  - Ingress
  - Egress
  
  # ì„œë¹„ìŠ¤ ë©”ì‹œ ë‚´ í†µì‹ 
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/part-of: microservices
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090  # ë©”íŠ¸ë¦­
  
  # ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬
  - from:
    - podSelector:
        matchLabels:
          app: service-discovery
    ports:
    - protocol: TCP
      port: 8080
  
  egress:
  # ë‹¤ë¥¸ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í˜¸ì¶œ
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/part-of: microservices
    ports:
    - protocol: TCP
      port: 8080
  
  # ì„œë¹„ìŠ¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì ‘ê·¼
  - to:
    - podSelector:
        matchLabels:
          app: service-registry
    ports:
    - protocol: TCP
      port: 8761  # Eureka
    - protocol: TCP
      port: 8500  # Consul
```

### ë©€í‹° í…Œë„ŒíŠ¸ ê²©ë¦¬

```yaml
# multi-tenant-isolation.yaml
---
# í…Œë„ŒíŠ¸ A ê²©ë¦¬
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tenant-a-isolation
  namespace: tenant-a
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  
  # í…Œë„ŒíŠ¸ Aë§Œ ì ‘ê·¼ ê°€ëŠ¥
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          tenant: tenant-a
  - from:
    - ipBlock:
        cidr: 192.168.100.0/24  # í…Œë„ŒíŠ¸ A ì „ìš© ë„¤íŠ¸ì›Œí¬
  
  # í…Œë„ŒíŠ¸ A ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë§Œ ì ‘ê·¼
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          tenant: tenant-a
  - to:
    - ipBlock:
        cidr: 192.168.100.0/24
    - ipBlock:
        cidr: 192.168.200.0/24  # ê³µìœ  ì„œë¹„ìŠ¤ ë„¤íŠ¸ì›Œí¬

---
# ê³µìœ  ì„œë¹„ìŠ¤ ì ‘ê·¼ ì •ì±…
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: shared-services-access
  namespace: shared-services
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  
  # ëª¨ë“  í…Œë„ŒíŠ¸ì—ì„œ ì ‘ê·¼ í—ˆìš©
  ingress:
  - from:
    - namespaceSelector:
        matchExpressions:
        - key: tenant
          operator: Exists
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
```

## ğŸ› ï¸ ë„¤íŠ¸ì›Œí¬ ì •ì±… ê´€ë¦¬ ë„êµ¬

### ì •ì±… ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# validate-network-policies.sh

NAMESPACE=${1:-production}

echo "=== Network Policy Validation for $NAMESPACE ==="

# 1. í˜„ì¬ ì ìš©ëœ ì •ì±… í™•ì¸
check_existing_policies() {
    echo "1. Existing Network Policies:"
    kubectl get networkpolicy -n $NAMESPACE -o wide
    echo
    
    # ì •ì±…ì´ ì—†ëŠ” ê²½ìš° ê²½ê³ 
    policy_count=$(kubectl get networkpolicy -n $NAMESPACE --no-headers | wc -l)
    if [ $policy_count -eq 0 ]; then
        echo "âš ï¸ WARNING: No network policies found in namespace $NAMESPACE"
        echo "   All traffic is allowed by default!"
    fi
}

# 2. Podì™€ ì •ì±… ë§¤ì¹­ í™•ì¸
check_pod_policy_matching() {
    echo "2. Pod-Policy Matching Analysis:"
    
    # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ëª¨ë“  Pod í™•ì¸
    kubectl get pods -n $NAMESPACE --no-headers | while read pod_name status ready restarts age; do
        echo "Pod: $pod_name"
        
        # Pod ë¼ë²¨ í™•ì¸
        pod_labels=$(kubectl get pod $pod_name -n $NAMESPACE --show-labels --no-headers | awk '{print $NF}')
        echo "  Labels: $pod_labels"
        
        # ì ìš©ë˜ëŠ” ì •ì±… í™•ì¸
        matching_policies=$(kubectl get networkpolicy -n $NAMESPACE -o json | jq -r --arg labels "$pod_labels" '
        .items[] | 
        select(
            .spec.podSelector.matchLabels // {} | 
            to_entries | 
            all(.key + "=" + .value | IN($labels | split(",")))
        ) | 
        .metadata.name')
        
        if [ -n "$matching_policies" ]; then
            echo "  Matching Policies: $matching_policies"
        else
            echo "  âš ï¸ No matching policies (default allow)"
        fi
        echo
    done
}

# 3. ì •ì±… ì¶©ëŒ ê²€ì‚¬
check_policy_conflicts() {
    echo "3. Policy Conflict Analysis:"
    
    # ì¤‘ë³µë˜ëŠ” podSelector í™•ì¸
    kubectl get networkpolicy -n $NAMESPACE -o json | jq -r '
    .items[] | 
    {name: .metadata.name, selector: .spec.podSelector} | 
    @json' | sort | uniq -c | while read count policy; do
        if [ $count -gt 1 ]; then
            echo "âš ï¸ Potential conflict: $count policies with same selector"
            echo "   Policy: $policy"
        fi
    done
}

# 4. ì—°ê²°ì„± í…ŒìŠ¤íŠ¸
test_connectivity() {
    echo "4. Connectivity Test:"
    
    # í…ŒìŠ¤íŠ¸ Pod ìƒì„±
    kubectl run netpol-test-client --image=busybox --rm -it --restart=Never -n $NAMESPACE -- sleep 3600 &
    test_pod_pid=$!
    
    # Pod ì¤€ë¹„ ëŒ€ê¸°
    sleep 10
    
    # ê¸°ë³¸ ì—°ê²°ì„± í…ŒìŠ¤íŠ¸
    echo "Testing DNS resolution:"
    kubectl exec netpol-test-client -n $NAMESPACE -- nslookup kubernetes.default.svc.cluster.local
    
    echo "Testing external connectivity:"
    kubectl exec netpol-test-client -n $NAMESPACE -- ping -c 3 8.8.8.8
    
    # ì •ë¦¬
    kill $test_pod_pid 2>/dev/null || true
}

# 5. ì •ì±… ê¶Œì¥ì‚¬í•­
provide_recommendations() {
    echo "5. Security Recommendations:"
    
    # Default deny ì •ì±… í™•ì¸
    default_deny=$(kubectl get networkpolicy -n $NAMESPACE -o json | jq -r '.items[] | select(.spec.podSelector == {}) | .metadata.name')
    
    if [ -z "$default_deny" ]; then
        echo "âš ï¸ CRITICAL: No default deny policy found"
        echo "   Recommendation: Apply default-deny-all policy"
        echo "   kubectl apply -f default-deny-all.yaml"
    fi
    
    # DNS ì •ì±… í™•ì¸
    dns_policy=$(kubectl get networkpolicy -n $NAMESPACE -o json | jq -r '.items[] | select(.spec.egress[]?.ports[]?.port == 53) | .metadata.name' | head -1)
    
    if [ -z "$dns_policy" ]; then
        echo "âš ï¸ WARNING: No explicit DNS access policy found"
        echo "   Recommendation: Apply DNS access policy"
    fi
    
    # ê³¼ë„í•œ ê¶Œí•œ í™•ì¸
    broad_policies=$(kubectl get networkpolicy -n $NAMESPACE -o json | jq -r '.items[] | select(.spec.ingress[]?.from == [] or .spec.egress[]?.to == []) | .metadata.name')
    
    if [ -n "$broad_policies" ]; then
        echo "âš ï¸ WARNING: Overly permissive policies found:"
        echo "$broad_policies"
        echo "   Recommendation: Restrict access to specific sources/destinations"
    fi
}

# ì‹¤í–‰
check_existing_policies
check_pod_policy_matching
check_policy_conflicts
test_connectivity
provide_recommendations

echo "=== Network Policy Validation Complete ==="
```

### ì •ì±… ìƒì„± í—¬í¼

```bash
#!/bin/bash
# generate-network-policy.sh

APP_NAME=$1
NAMESPACE=$2
TIER=$3

if [ $# -ne 3 ]; then
    echo "Usage: $0 <app-name> <namespace> <tier>"
    echo "Example: $0 web-app production frontend"
    exit 1
fi

echo "Generating network policy for $APP_NAME in $NAMESPACE ($TIER tier)"

# í‹°ì–´ë³„ ê¸°ë³¸ ì •ì±… ìƒì„±
case $TIER in
    frontend)
        generate_frontend_policy
        ;;
    backend)
        generate_backend_policy
        ;;
    database)
        generate_database_policy
        ;;
    *)
        generate_generic_policy
        ;;
esac

generate_frontend_policy() {
    cat > ${APP_NAME}-network-policy.yaml << EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ${APP_NAME}-policy
  namespace: ${NAMESPACE}
spec:
  podSelector:
    matchLabels:
      app: ${APP_NAME}
      tier: ${TIER}
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Allow from ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  
  egress:
  # Allow to backend services
  - to:
    - podSelector:
        matchLabels:
          tier: backend
    ports:
    - protocol: TCP
      port: 8080
  
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
EOF
}

generate_backend_policy() {
    cat > ${APP_NAME}-network-policy.yaml << EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ${APP_NAME}-policy
  namespace: ${NAMESPACE}
spec:
  podSelector:
    matchLabels:
      app: ${APP_NAME}
      tier: ${TIER}
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Allow from frontend
  - from:
    - podSelector:
        matchLabels:
          tier: frontend
    ports:
    - protocol: TCP
      port: 8080
  
  egress:
  # Allow to database
  - to:
    - podSelector:
        matchLabels:
          tier: database
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 5432
  
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
EOF
}

generate_database_policy() {
    cat > ${APP_NAME}-network-policy.yaml << EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ${APP_NAME}-policy
  namespace: ${NAMESPACE}
spec:
  podSelector:
    matchLabels:
      app: ${APP_NAME}
      tier: ${TIER}
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Allow from backend only
  - from:
    - podSelector:
        matchLabels:
          tier: backend
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 5432
  
  egress:
  # Minimal egress for updates/backups
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: UDP
      port: 123  # NTP
EOF
}

echo "Network policy generated: ${APP_NAME}-network-policy.yaml"
echo "Review and apply with: kubectl apply -f ${APP_NAME}-network-policy.yaml"
```

## ğŸ“Š ë„¤íŠ¸ì›Œí¬ ì •ì±… ëª¨ë‹ˆí„°ë§

### ì •ì±… íš¨ê³¼ ëª¨ë‹ˆí„°ë§

```yaml
# network-policy-monitoring.yaml
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: netpol-monitor-script
  namespace: monitoring
data:
  monitor.sh: |
    #!/bin/bash
    
    # ë„¤íŠ¸ì›Œí¬ ì •ì±… ìœ„ë°˜ ëª¨ë‹ˆí„°ë§
    monitor_violations() {
        echo "=== Network Policy Violations ==="
        
        # iptables ë¡œê·¸ì—ì„œ ì°¨ë‹¨ëœ íŒ¨í‚· í™•ì¸
        journalctl -u iptables --since "1 hour ago" | grep "DENY" | tail -10
        
        # Calico ë¡œê·¸ì—ì„œ ì •ì±… ì ìš© í™•ì¸
        kubectl logs -n calico-system -l k8s-app=calico-node --tail=100 | grep -i "policy"
    }
    
    # ì •ì±… ì ìš© ìƒíƒœ í™•ì¸
    check_policy_status() {
        echo "=== Policy Application Status ==="
        
        for ns in $(kubectl get namespaces -o name | cut -d/ -f2); do
            policy_count=$(kubectl get networkpolicy -n $ns --no-headers | wc -l)
            pod_count=$(kubectl get pods -n $ns --no-headers | wc -l)
            
            echo "Namespace: $ns, Policies: $policy_count, Pods: $pod_count"
            
            if [ $pod_count -gt 0 ] && [ $policy_count -eq 0 ]; then
                echo "  âš ï¸ WARNING: Pods without network policies"
            fi
        done
    }
    
    monitor_violations
    check_policy_status

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: netpol-monitor
  namespace: monitoring
spec:
  schedule: "*/15 * * * *"  # 15ë¶„ë§ˆë‹¤ ì‹¤í–‰
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: monitor
            image: kubectl:latest
            command: ["/bin/bash"]
            args: ["/scripts/monitor.sh"]
            volumeMounts:
            - name: script
              mountPath: /scripts
          volumes:
          - name: script
            configMap:
              name: netpol-monitor-script
              defaultMode: 0755
          restartPolicy: OnFailure
```

## ğŸ“‹ ë„¤íŠ¸ì›Œí¬ ì •ì±… ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. ì •ì±… ì„¤ê³„ ì›ì¹™

- **ìµœì†Œ ê¶Œí•œ ì›ì¹™**: í•„ìš”í•œ ìµœì†Œí•œì˜ íŠ¸ë˜í”½ë§Œ í—ˆìš©
- **ê³„ì¸µë³„ ê²©ë¦¬**: 3-tier ì•„í‚¤í…ì²˜ì— ë”°ë¥¸ ê³„ì¸µë³„ ì •ì±… ì ìš©
- **ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²©ë¦¬**: í™˜ê²½ë³„, í…Œë„ŒíŠ¸ë³„ ê²©ë¦¬
- **Default Deny**: ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  íŠ¸ë˜í”½ ì°¨ë‹¨ í›„ í•„ìš”í•œ ê²ƒë§Œ í—ˆìš©

### 2. ê°œë°œ ë° ìš´ì˜ í”„ë¡œì„¸ìŠ¤

- **ë‹¨ê³„ì  ì ìš©**: ê°œë°œ â†’ ìŠ¤í…Œì´ì§• â†’ ìš´ì˜ ìˆœì„œë¡œ ì ìš©
- **ì •ì±… í…ŒìŠ¤íŠ¸**: ìƒˆ ì •ì±… ì ìš© ì „ ì¶©ë¶„í•œ í…ŒìŠ¤íŠ¸
- **ëª¨ë‹ˆí„°ë§**: ì •ì±… ì ìš© í›„ íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§
- **ë¬¸ì„œí™”**: ëª¨ë“  ì •ì±…ì˜ ëª©ì ê³¼ íš¨ê³¼ ë¬¸ì„œí™”

### 3. ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

- **CNI ì„±ëŠ¥**: ì •ì±… ìˆ˜ê°€ ë§ì„ìˆ˜ë¡ ë„¤íŠ¸ì›Œí¬ ì„±ëŠ¥ ì˜í–¥
- **ì •ì±… ìµœì í™”**: ë¶ˆí•„ìš”í•œ ì •ì±… ì œê±°, ì¤‘ë³µ ì •ì±… í†µí•©
- **ì„ íƒì ìµœì í™”**: íš¨ìœ¨ì ì¸ ë¼ë²¨ ì„ íƒì ì‚¬ìš©

---

> ğŸ’¡ **ì‹¤ì „ ê²½í—˜**: ë„¤íŠ¸ì›Œí¬ ì •ì±…ì€ ë‹¨ê³„ì ìœ¼ë¡œ ì ìš©í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ì²˜ìŒì—ëŠ” ëª¨ë‹ˆí„°ë§ ëª¨ë“œë¡œ ì‹œì‘í•´ì„œ íŠ¸ë˜í”½ íŒ¨í„´ì„ íŒŒì•…í•œ í›„, ì ì§„ì ìœ¼ë¡œ ì œí•œì„ ê°•í™”í•´ë‚˜ê°€ì„¸ìš”. íŠ¹íˆ DNS ì •ì±…ì€ í•„ìˆ˜ì ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•˜ë©°, ê°œë°œíŒ€ê³¼ì˜ ê¸´ë°€í•œ í˜‘ì¡°ê°€ í•„ìš”í•©ë‹ˆë‹¤.

íƒœê·¸: #network-policy #security #zero-trust #segmentation #onprem #calico
