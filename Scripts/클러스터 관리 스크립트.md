# í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸

## ğŸ¯ ê°œìš”

ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° ìš´ì˜ì„ ìœ„í•œ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ëª¨ìŒì…ë‹ˆë‹¤. ì¼ìƒì ì¸ ê´€ë¦¬ ì‘ì—…ì„ íš¨ìœ¨í™”í•˜ê³  ì‹¤ìˆ˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.

## ğŸ” í´ëŸ¬ìŠ¤í„° ìƒíƒœ ì ê²€ ìŠ¤í¬ë¦½íŠ¸

### ì¢…í•© ìƒíƒœ ì ê²€

```bash
#!/bin/bash
# cluster-health-check.sh

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

LOG_FILE="/var/log/k8s-health-check-$(date +%Y%m%d_%H%M%S).log"

log() { echo -e "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"; }
success() { echo -e "${GREEN}âœ“${NC} $1" | tee -a "$LOG_FILE"; }
warning() { echo -e "${YELLOW}âš ${NC} $1" | tee -a "$LOG_FILE"; }
error() { echo -e "${RED}âœ—${NC} $1" | tee -a "$LOG_FILE"; }
info() { echo -e "${BLUE}â„¹${NC} $1" | tee -a "$LOG_FILE"; }

# API ì„œë²„ ìƒíƒœ í™•ì¸
check_api_server() {
    info "Checking API Server..."
    if kubectl cluster-info > /dev/null 2>&1; then
        success "API Server is responding"
        local version=$(kubectl version --short | grep "Server Version" | awk '{print $3}')
        info "API Server Version: $version"
    else
        error "API Server is not responding"
        return 1
    fi
}

# ë…¸ë“œ ìƒíƒœ í™•ì¸
check_nodes() {
    info "Checking Node Status..."
    local total_nodes=$(kubectl get nodes --no-headers | wc -l)
    local ready_nodes=$(kubectl get nodes --no-headers | grep -w Ready | wc -l)
    local not_ready_nodes=$((total_nodes - ready_nodes))
    
    info "Total Nodes: $total_nodes"
    success "Ready Nodes: $ready_nodes"
    
    if [ $not_ready_nodes -eq 0 ]; then
        success "All nodes are Ready"
    else
        error "Not Ready Nodes: $not_ready_nodes"
    fi
}

# ì‹œìŠ¤í…œ Pod ìƒíƒœ í™•ì¸
check_system_pods() {
    info "Checking System Pods..."
    local running_pods=$(kubectl get pods -n kube-system --no-headers | grep Running | wc -l)
    local failed_pods=$(kubectl get pods -n kube-system --no-headers | grep -v Running | grep -v Completed | wc -l)
    
    success "Running System Pods: $running_pods"
    if [ $failed_pods -eq 0 ]; then
        success "All system pods are healthy"
    else
        error "Failed System Pods: $failed_pods"
    fi
}

# ë©”ì¸ ì‹¤í–‰
main() {
    log "Starting Kubernetes cluster health check..."
    check_api_server
    check_nodes
    check_system_pods
    log "Health check completed"
}

main "$@"
```

## ğŸ”„ ë°±ì—… ìë™í™” ìŠ¤í¬ë¦½íŠ¸

### etcd ë°±ì—… ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# etcd-backup.sh

BACKUP_DIR="/var/backups/etcd"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/etcd-snapshot-$DATE.db"

mkdir -p "$BACKUP_DIR"

# etcd ë°±ì—… ì‹¤í–‰
ETCDCTL_API=3 etcdctl snapshot save "$BACKUP_FILE" \
    --endpoints=https://127.0.0.1:2379 \
    --cacert=/etc/kubernetes/pki/etcd/ca.crt \
    --cert=/etc/kubernetes/pki/etcd/server.crt \
    --key=/etc/kubernetes/pki/etcd/server.key

# ë°±ì—… ê²€ì¦
ETCDCTL_API=3 etcdctl snapshot status "$BACKUP_FILE"

# ì••ì¶•
gzip "$BACKUP_FILE"

# 30ì¼ ì´ìƒëœ ë°±ì—… ì‚­ì œ
find "$BACKUP_DIR" -name "etcd-snapshot-*.db.gz" -mtime +30 -delete

echo "etcd backup completed: $BACKUP_FILE.gz"
```

## ğŸ“Š ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸

### ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ì²´í¬

```bash
#!/bin/bash
# resource-monitor.sh

echo "=== Kubernetes Resource Monitor ==="
echo "Timestamp: $(date)"
echo

echo "=== Node Resource Usage ==="
kubectl top nodes 2>/dev/null || echo "Metrics server not available"
echo

echo "=== Top CPU Consuming Pods ==="
kubectl top pods --all-namespaces --sort-by=cpu | head -10
echo

echo "=== Top Memory Consuming Pods ==="
kubectl top pods --all-namespaces --sort-by=memory | head -10
echo

echo "=== PersistentVolume Usage ==="
kubectl get pv -o custom-columns=NAME:.metadata.name,CAPACITY:.spec.capacity.storage,STATUS:.status.phase,CLAIM:.spec.claimRef.name
echo

echo "=== Events (Last 10) ==="
kubectl get events --sort-by='.lastTimestamp' --all-namespaces | tail -10
```

## ğŸ”§ ë…¸ë“œ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸

### ë…¸ë“œ ë“œë ˆì¸ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# node-drain.sh

usage() {
    echo "Usage: $0 <drain|uncordon> <node-name>"
    echo "Examples:"
    echo "  $0 drain worker-01"
    echo "  $0 uncordon worker-01"
}

drain_node() {
    local node=$1
    echo "Draining node: $node"
    
    # í˜„ì¬ Pod ìˆ˜ í™•ì¸
    local pod_count=$(kubectl get pods --all-namespaces --field-selector spec.nodeName="$node" --no-headers | wc -l)
    echo "Current pods on node: $pod_count"
    
    if [ $pod_count -gt 0 ]; then
        echo "This will evict pods from the node"
        read -p "Continue? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Drain cancelled"
            exit 0
        fi
    fi
    
    kubectl drain "$node" --ignore-daemonsets --delete-emptydir-data --timeout=300s
    echo "Node $node drained successfully"
}

uncordon_node() {
    local node=$1
    echo "Uncordoning node: $node"
    kubectl uncordon "$node"
    echo "Node $node is now schedulable"
}

if [ $# -ne 2 ]; then
    usage
    exit 1
fi

command=$1
node=$2

case $command in
    drain)
        drain_node "$node"
        ;;
    uncordon)
        uncordon_node "$node"
        ;;
    *)
        usage
        exit 1
        ;;
esac
```

## ğŸ—‚ï¸ ì„¤ì • ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸

### ConfigMap ë° Secret ë°±ì—…

```bash
#!/bin/bash
# config-backup.sh

BACKUP_DIR="/var/backups/k8s-configs"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"

echo "Backing up Kubernetes configurations..."

# ConfigMap ë°±ì—…
echo "Backing up ConfigMaps..."
kubectl get configmaps --all-namespaces -o yaml > "$BACKUP_DIR/configmaps-$DATE.yaml"

# Secret ë°±ì—… (base64 ì¸ì½”ë”©ë¨)
echo "Backing up Secrets..."
kubectl get secrets --all-namespaces -o yaml > "$BACKUP_DIR/secrets-$DATE.yaml"

# ëª¨ë“  ë¦¬ì†ŒìŠ¤ ë°±ì—…
echo "Backing up all resources..."
kubectl get all --all-namespaces -o yaml > "$BACKUP_DIR/all-resources-$DATE.yaml"

# ì••ì¶•
tar -czf "$BACKUP_DIR/k8s-config-backup-$DATE.tar.gz" -C "$BACKUP_DIR" \
    "configmaps-$DATE.yaml" \
    "secrets-$DATE.yaml" \
    "all-resources-$DATE.yaml"

# ê°œë³„ íŒŒì¼ ì‚­ì œ
rm "$BACKUP_DIR/configmaps-$DATE.yaml" \
   "$BACKUP_DIR/secrets-$DATE.yaml" \
   "$BACKUP_DIR/all-resources-$DATE.yaml"

# 7ì¼ ì´ìƒëœ ë°±ì—… ì‚­ì œ
find "$BACKUP_DIR" -name "k8s-config-backup-*.tar.gz" -mtime +7 -delete

echo "Configuration backup completed: $BACKUP_DIR/k8s-config-backup-$DATE.tar.gz"
```

## ğŸš¨ ì•Œë¦¼ ìŠ¤í¬ë¦½íŠ¸

### Slack ì•Œë¦¼ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# slack-notify.sh

SLACK_WEBHOOK_URL="https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"

send_slack_notification() {
    local message=$1
    local color=${2:-"good"}  # good, warning, danger
    local channel=${3:-"#kubernetes"}
    
    local payload=$(cat <<EOF
{
    "channel": "$channel",
    "username": "k8s-monitor",
    "icon_emoji": ":kubernetes:",
    "attachments": [
        {
            "color": "$color",
            "fields": [
                {
                    "title": "Kubernetes Cluster Alert",
                    "value": "$message",
                    "short": false
                }
            ],
            "footer": "$(hostname)",
            "ts": $(date +%s)
        }
    ]
}
EOF
)
    
    curl -X POST -H 'Content-type: application/json' \
         --data "$payload" \
         "$SLACK_WEBHOOK_URL"
}

# ì‚¬ìš© ì˜ˆì œ
case "${1:-}" in
    critical)
        send_slack_notification "ğŸš¨ Critical: $2" "danger"
        ;;
    warning)
        send_slack_notification "âš ï¸ Warning: $2" "warning"
        ;;
    info)
        send_slack_notification "â„¹ï¸ Info: $2" "good"
        ;;
    *)
        echo "Usage: $0 {critical|warning|info} <message>"
        exit 1
        ;;
esac
```

## ğŸ” ë””ë²„ê¹… ìŠ¤í¬ë¦½íŠ¸

### Pod íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# pod-debug.sh

usage() {
    echo "Usage: $0 <pod-name> [namespace]"
    echo "Example: $0 my-app-pod production"
}

debug_pod() {
    local pod=$1
    local namespace=${2:-default}
    
    echo "=== Debugging Pod: $pod in namespace: $namespace ==="
    echo
    
    # Pod ê¸°ë³¸ ì •ë³´
    echo "=== Pod Status ==="
    kubectl get pod "$pod" -n "$namespace" -o wide
    echo
    
    # Pod ìƒì„¸ ì •ë³´
    echo "=== Pod Description ==="
    kubectl describe pod "$pod" -n "$namespace"
    echo
    
    # Pod ë¡œê·¸
    echo "=== Pod Logs (Last 50 lines) ==="
    kubectl logs "$pod" -n "$namespace" --tail=50
    echo
    
    # ì´ì „ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ì¬ì‹œì‘ëœ ê²½ìš°)
    echo "=== Previous Container Logs ==="
    kubectl logs "$pod" -n "$namespace" --previous 2>/dev/null || echo "No previous container logs"
    echo
    
    # Pod ì´ë²¤íŠ¸
    echo "=== Related Events ==="
    kubectl get events -n "$namespace" --field-selector involvedObject.name="$pod" --sort-by='.lastTimestamp'
    echo
    
    # ë…¸ë“œ ì •ë³´
    local node=$(kubectl get pod "$pod" -n "$namespace" -o jsonpath='{.spec.nodeName}')
    if [ -n "$node" ]; then
        echo "=== Node Information ==="
        echo "Pod is scheduled on node: $node"
        kubectl describe node "$node" | grep -A 5 "Conditions:"
    fi
}

if [ $# -lt 1 ]; then
    usage
    exit 1
fi

debug_pod "$@"
```

## ğŸ“‹ ì¼ì¼ ì ê²€ ìŠ¤í¬ë¦½íŠ¸

### ë§¤ì¼ ì‹¤í–‰í•  ì ê²€ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# daily-check.sh

REPORT_FILE="/var/log/k8s-daily-report-$(date +%Y%m%d).log"

{
    echo "======================================"
    echo "Kubernetes Daily Health Check Report"
    echo "Date: $(date)"
    echo "======================================"
    echo
    
    # í´ëŸ¬ìŠ¤í„° ê¸°ë³¸ ì •ë³´
    echo "=== Cluster Information ==="
    kubectl cluster-info
    echo
    
    # ë…¸ë“œ ìƒíƒœ
    echo "=== Node Status ==="
    kubectl get nodes -o wide
    echo
    
    # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë³„ Pod ìƒíƒœ
    echo "=== Pod Status by Namespace ==="
    for ns in $(kubectl get namespaces -o name | cut -d/ -f2); do
        echo "Namespace: $ns"
        kubectl get pods -n "$ns" --no-headers | awk '{print $3}' | sort | uniq -c
        echo
    done
    
    # ìŠ¤í† ë¦¬ì§€ ìƒíƒœ
    echo "=== Storage Status ==="
    kubectl get pv,pvc --all-namespaces
    echo
    
    # ìµœê·¼ ì´ë²¤íŠ¸ (Warningë§Œ)
    echo "=== Recent Warning Events ==="
    kubectl get events --all-namespaces --field-selector type=Warning --sort-by='.lastTimestamp' | tail -10
    echo
    
    # ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰
    echo "=== Resource Usage ==="
    kubectl top nodes 2>/dev/null || echo "Metrics server not available"
    echo
    
    # ì¸ì¦ì„œ ë§Œë£Œ í™•ì¸
    echo "=== Certificate Status ==="
    kubeadm certs check-expiration 2>/dev/null || echo "kubeadm not available or not a kubeadm cluster"
    
} > "$REPORT_FILE"

# ê²°ê³¼ ìš”ì•½
error_count=$(grep -c "Error\|Failed\|Warning" "$REPORT_FILE" || true)
if [ "$error_count" -gt 0 ]; then
    echo "Daily check completed with $error_count issues found. Check $REPORT_FILE for details."
    # ì•Œë¦¼ ë°œì†¡ (ì˜µì…˜)
    # ./slack-notify.sh warning "Daily check found $error_count issues in the cluster"
else
    echo "Daily check completed successfully. No issues found."
fi

echo "Report saved to: $REPORT_FILE"
```

## ğŸ”„ Cron ì„¤ì • ì˜ˆì œ

### crontab ì„¤ì •

```bash
# Kubernetes ê´€ë¦¬ ì‘ì—… crontab ì˜ˆì œ
# crontab -e ë¡œ í¸ì§‘

# etcd ë°±ì—… (ë§¤ì¼ ì˜¤ì „ 2ì‹œ)
0 2 * * * /path/to/etcd-backup.sh >> /var/log/etcd-backup.log 2>&1

# ì¼ì¼ ê±´ê°• ì²´í¬ (ë§¤ì¼ ì˜¤ì „ 6ì‹œ)
0 6 * * * /path/to/daily-check.sh

# ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ (ë§¤ì‹œê°„)
0 * * * * /path/to/resource-monitor.sh >> /var/log/resource-monitor.log 2>&1

# ì„¤ì • ë°±ì—… (ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 3ì‹œ)
0 3 * * 0 /path/to/config-backup.sh >> /var/log/config-backup.log 2>&1

# ë¡œê·¸ ì •ë¦¬ (ë§¤ì¼ ì˜¤ì „ 4ì‹œ)
0 4 * * * find /var/log -name "k8s-*.log" -mtime +30 -delete
```

---

> ğŸ’¡ **ì‚¬ìš© íŒ**: ì´ ìŠ¤í¬ë¦½íŠ¸ë“¤ì„ ì‚¬ìš©í•˜ê¸° ì „ì— í™˜ê²½ì— ë§ê²Œ ê²½ë¡œì™€ ì„¤ì •ì„ ìˆ˜ì •í•˜ì„¸ìš”. íŠ¹íˆ ë°±ì—… ê²½ë¡œ, Slack webhook URL, SSH í‚¤ ì„¤ì • ë“±ì„ í™•ì¸í•˜ê³  í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ë¨¼ì € ê²€ì¦í•´ë³´ì„¸ìš”.

íƒœê·¸: #scripts #automation #backup #monitoring #maintenance