# ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ í…œí”Œë¦¿

ë‚ ì§œ: {{date}}
ìƒì„±ì: {{user}}

## ğŸ“¦ ê¸°ë³¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬

### ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ í…œí”Œë¦¿

```yaml
# web-app-template.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{APP_NAME}}
  namespace: {{NAMESPACE}}
  labels:
    app: {{APP_NAME}}
    version: {{APP_VERSION}}
    environment: {{ENVIRONMENT}}
spec:
  replicas: {{REPLICA_COUNT}}
  selector:
    matchLabels:
      app: {{APP_NAME}}
  template:
    metadata:
      labels:
        app: {{APP_NAME}}
        version: {{APP_VERSION}}
        environment: {{ENVIRONMENT}}
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "{{METRICS_PORT}}"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: {{APP_NAME}}
        image: {{IMAGE_REGISTRY}}/{{APP_NAME}}:{{APP_VERSION}}
        ports:
        - containerPort: {{APP_PORT}}
          name: http
        - containerPort: {{METRICS_PORT}}
          name: metrics
        env:
        - name: LOG_LEVEL
          value: "{{LOG_LEVEL}}"
        - name: ENVIRONMENT
          value: "{{ENVIRONMENT}}"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: {{APP_NAME}}-secrets
              key: database-url
        resources:
          requests:
            memory: "{{MEMORY_REQUEST}}"
            cpu: "{{CPU_REQUEST}}"
          limits:
            memory: "{{MEMORY_LIMIT}}"
            cpu: "{{CPU_LIMIT}}"
        livenessProbe:
          httpGet:
            path: /health
            port: {{APP_PORT}}
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: {{APP_PORT}}
          initialDelaySeconds: 5
          periodSeconds: 5
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
        - name: logs-volume
          mountPath: /app/logs
      volumes:
      - name: config-volume
        configMap:
          name: {{APP_NAME}}-config
      - name: logs-volume
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: {{APP_NAME}}-service
  namespace: {{NAMESPACE}}
  labels:
    app: {{APP_NAME}}
spec:
  selector:
    app: {{APP_NAME}}
  ports:
  - name: http
    port: 80
    targetPort: {{APP_PORT}}
  - name: metrics
    port: {{METRICS_PORT}}
    targetPort: {{METRICS_PORT}}
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{APP_NAME}}-config
  namespace: {{NAMESPACE}}
data:
  app.properties: |
    server.port={{APP_PORT}}
    logging.level.root={{LOG_LEVEL}}
    management.endpoints.web.exposure.include=health,info,metrics
    management.endpoint.health.show-details=always

---
apiVersion: v1
kind: Secret
metadata:
  name: {{APP_NAME}}-secrets
  namespace: {{NAMESPACE}}
type: Opaque
data:
  database-url: {{DATABASE_URL_BASE64}}
  api-key: {{API_KEY_BASE64}}
```

### ë³€ìˆ˜ ì„¤ì • ì˜ˆì œ

```bash
# variables.env
# ì• í”Œë¦¬ì¼€ì´ì…˜ ê¸°ë³¸ ì •ë³´
APP_NAME=my-web-app
APP_VERSION=v1.0.0
NAMESPACE=production
ENVIRONMENT=production

# ì´ë¯¸ì§€ ì„¤ì •
IMAGE_REGISTRY=registry.company.local

# ë¦¬ì†ŒìŠ¤ ì„¤ì •
REPLICA_COUNT=3
MEMORY_REQUEST=256Mi
MEMORY_LIMIT=512Mi
CPU_REQUEST=100m
CPU_LIMIT=500m

# ë„¤íŠ¸ì›Œí¬ ì„¤ì •
APP_PORT=8080
METRICS_PORT=9090

# ë¡œê¹… ì„¤ì •
LOG_LEVEL=info

# ì‹œí¬ë¦¿ (base64 ì¸ì½”ë”© í•„ìš”)
DATABASE_URL_BASE64=cG9zdGdyZXNxbDovL3VzZXI6cGFzc0BkYi5jb21wYW55LmxvY2FsOjU0MzIvbXlkYg==
API_KEY_BASE64=YWJjZGVmZ2hpams=
```

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ í…œí”Œë¦¿

### PostgreSQL StatefulSet

```yaml
# postgresql-template.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{DB_NAME}}-postgresql
  namespace: {{NAMESPACE}}
spec:
  serviceName: {{DB_NAME}}-postgresql-headless
  replicas: {{DB_REPLICAS}}
  selector:
    matchLabels:
      app: {{DB_NAME}}-postgresql
  template:
    metadata:
      labels:
        app: {{DB_NAME}}-postgresql
        role: {{DB_ROLE}}
    spec:
      securityContext:
        fsGroup: 999
      containers:
      - name: postgresql
        image: postgres:{{POSTGRES_VERSION}}-alpine
        ports:
        - containerPort: 5432
          name: postgresql
        env:
        - name: POSTGRES_DB
          value: "{{DB_NAME}}"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: {{DB_NAME}}-postgresql-secret
              key: username
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{DB_NAME}}-postgresql-secret
              key: password
        - name: PGDATA
          value: "/var/lib/postgresql/data/pgdata"
        resources:
          requests:
            memory: "{{DB_MEMORY_REQUEST}}"
            cpu: "{{DB_CPU_REQUEST}}"
          limits:
            memory: "{{DB_MEMORY_LIMIT}}"
            cpu: "{{DB_CPU_LIMIT}}"
        volumeMounts:
        - name: postgresql-data
          mountPath: /var/lib/postgresql/data
        - name: postgresql-config
          mountPath: /etc/postgresql/postgresql.conf
          subPath: postgresql.conf
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - exec pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB" -h 127.0.0.1 -p 5432
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - exec pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB" -h 127.0.0.1 -p 5432
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
      volumes:
      - name: postgresql-config
        configMap:
          name: {{DB_NAME}}-postgresql-config
  volumeClaimTemplates:
  - metadata:
      name: postgresql-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "{{DB_STORAGE_CLASS}}"
      resources:
        requests:
          storage: {{DB_STORAGE_SIZE}}

---
apiVersion: v1
kind: Service
metadata:
  name: {{DB_NAME}}-postgresql
  namespace: {{NAMESPACE}}
spec:
  selector:
    app: {{DB_NAME}}-postgresql
  ports:
  - port: 5432
    targetPort: 5432
    name: postgresql
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: {{DB_NAME}}-postgresql-headless
  namespace: {{NAMESPACE}}
spec:
  clusterIP: None
  selector:
    app: {{DB_NAME}}-postgresql
  ports:
  - port: 5432
    targetPort: 5432
    name: postgresql

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{DB_NAME}}-postgresql-config
  namespace: {{NAMESPACE}}
data:
  postgresql.conf: |
    # PostgreSQL ì„¤ì •
    listen_addresses = '*'
    port = 5432
    max_connections = {{DB_MAX_CONNECTIONS}}
    shared_buffers = {{DB_SHARED_BUFFERS}}
    effective_cache_size = {{DB_EFFECTIVE_CACHE_SIZE}}
    maintenance_work_mem = {{DB_MAINTENANCE_WORK_MEM}}
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    default_statistics_target = 100
    random_page_cost = 1.1
    effective_io_concurrency = 200
    
    # ë¡œê¹… ì„¤ì •
    log_destination = 'stderr'
    logging_collector = on
    log_directory = '/var/log/postgresql'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_statement = 'all'
    log_min_duration_statement = 1000

---
apiVersion: v1
kind: Secret
metadata:
  name: {{DB_NAME}}-postgresql-secret
  namespace: {{NAMESPACE}}
type: Opaque
data:
  username: {{DB_USERNAME_BASE64}}
  password: {{DB_PASSWORD_BASE64}}
```

## ğŸ”§ ëª¨ë‹ˆí„°ë§ í…œí”Œë¦¿

### ServiceMonitor í…œí”Œë¦¿

```yaml
# monitoring-template.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{APP_NAME}}-metrics
  namespace: {{NAMESPACE}}
  labels:
    app: {{APP_NAME}}
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app: {{APP_NAME}}
  endpoints:
  - port: metrics
    path: /metrics
    interval: 30s
    scrapeTimeout: 10s
    honorLabels: true

---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{APP_NAME}}-alerts
  namespace: {{NAMESPACE}}
  labels:
    app: {{APP_NAME}}
    monitoring: prometheus
spec:
  groups:
  - name: {{APP_NAME}}.rules
    rules:
    - alert: {{APP_NAME}}Down
      expr: up{job="{{APP_NAME}}"} == 0
      for: 5m
      labels:
        severity: critical
        service: {{APP_NAME}}
      annotations:
        summary: "{{APP_NAME}} is down"
        description: "{{APP_NAME}} has been down for more than 5 minutes."
        
    - alert: {{APP_NAME}}HighErrorRate
      expr: rate(http_requests_total{job="{{APP_NAME}}", status=~"5.."}[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        service: {{APP_NAME}}
      annotations:
        summary: "{{APP_NAME}} high error rate"
        description: "{{APP_NAME}} error rate is {{ $value }} errors per second."
        
    - alert: {{APP_NAME}}HighLatency
      expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="{{APP_NAME}}"}[5m])) > 0.5
      for: 10m
      labels:
        severity: warning
        service: {{APP_NAME}}
      annotations:
        summary: "{{APP_NAME}} high latency"
        description: "{{APP_NAME}} 95th percentile latency is {{ $value }}s."
```

## ğŸšª Ingress í…œí”Œë¦¿

### NGINX Ingress í…œí”Œë¦¿

```yaml
# ingress-template.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{APP_NAME}}-ingress
  namespace: {{NAMESPACE}}
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "{{SSL_REDIRECT}}"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "{{FORCE_SSL_REDIRECT}}"
    nginx.ingress.kubernetes.io/rate-limit: "{{RATE_LIMIT}}"
    nginx.ingress.kubernetes.io/rate-limit-window: "{{RATE_LIMIT_WINDOW}}"
    nginx.ingress.kubernetes.io/proxy-body-size: "{{MAX_BODY_SIZE}}"
    nginx.ingress.kubernetes.io/cors-allow-origin: "{{CORS_ORIGINS}}"
    nginx.ingress.kubernetes.io/cors-allow-methods: "{{CORS_METHODS}}"
    nginx.ingress.kubernetes.io/cors-allow-headers: "{{CORS_HEADERS}}"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options SAMEORIGIN always;
      add_header X-Content-Type-Options nosniff always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
spec:
  tls:
  - hosts:
    - {{DOMAIN_NAME}}
    secretName: {{TLS_SECRET_NAME}}
  rules:
  - host: {{DOMAIN_NAME}}
    http:
      paths:
      - path: {{URL_PATH}}
        pathType: {{PATH_TYPE}}
        backend:
          service:
            name: {{APP_NAME}}-service
            port:
              number: 80
```

## ğŸ”„ CI/CD í…œí”Œë¦¿

### GitLab CI í…œí”Œë¦¿

```yaml
# .gitlab-ci-template.yml
stages:
  - build
  - test
  - security
  - deploy-dev
  - deploy-staging
  - deploy-prod

variables:
  IMAGE_TAG: $CI_COMMIT_SHA
  KUBECONFIG_FILE: $KUBECONFIG_CONTENT

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$IMAGE_TAG .
    - docker push $CI_REGISTRY_IMAGE:$IMAGE_TAG
  only:
    - main
    - develop

test:
  stage: test
  image: $CI_REGISTRY_IMAGE:$IMAGE_TAG
  script:
    - echo "Running tests..."
    - ./run-tests.sh
  only:
    - main
    - develop

security-scan:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy image --exit-code 1 --severity HIGH,CRITICAL $CI_REGISTRY_IMAGE:$IMAGE_TAG
  allow_failure: true
  only:
    - main
    - develop

deploy-dev:
  stage: deploy-dev
  image: bitnami/kubectl:latest
  environment:
    name: development
  script:
    - echo $KUBECONFIG_CONTENT | base64 -d > kubeconfig
    - export KUBECONFIG=kubeconfig
    - envsubst < k8s/deployment-template.yaml | kubectl apply -f -
  variables:
    NAMESPACE: development
    REPLICA_COUNT: 1
    ENVIRONMENT: development
  only:
    - develop

deploy-staging:
  stage: deploy-staging
  image: bitnami/kubectl:latest
  environment:
    name: staging
  script:
    - echo $KUBECONFIG_CONTENT | base64 -d > kubeconfig
    - export KUBECONFIG=kubeconfig
    - envsubst < k8s/deployment-template.yaml | kubectl apply -f -
  variables:
    NAMESPACE: staging
    REPLICA_COUNT: 2
    ENVIRONMENT: staging
  only:
    - main
  when: manual

deploy-prod:
  stage: deploy-prod
  image: bitnami/kubectl:latest
  environment:
    name: production
  script:
    - echo $KUBECONFIG_CONTENT | base64 -d > kubeconfig
    - export KUBECONFIG=kubeconfig
    - envsubst < k8s/deployment-template.yaml | kubectl apply -f -
  variables:
    NAMESPACE: production
    REPLICA_COUNT: 3
    ENVIRONMENT: production
  only:
    - main
  when: manual
```

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

```markdown
# ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

## ğŸ”§ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤€ë¹„
- [ ] ëª¨ë“  ë³€ìˆ˜ê°€ ì ì ˆíˆ ì„¤ì •ë˜ì—ˆëŠ”ê°€?
- [ ] ì‹œí¬ë¦¿ì´ ì˜¬ë°”ë¥´ê²Œ ì¸ì½”ë”©ë˜ì—ˆëŠ”ê°€?
- [ ] ë¦¬ì†ŒìŠ¤ ìš”ì²­ëŸ‰/ì œí•œì´ ì ì ˆí•œê°€?
- [ ] í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ê°€ êµ¬í˜„ë˜ì—ˆëŠ”ê°€?

## ğŸ—ï¸ ì¸í”„ë¼ ì¤€ë¹„
- [ ] ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ê°€?
- [ ] í•„ìš”í•œ StorageClassê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ê°€?
- [ ] ë„¤íŠ¸ì›Œí¬ ì •ì±…ì´ ì ì ˆí•œê°€?
- [ ] Ingress ì„¤ì •ì´ ì˜¬ë°”ë¥¸ê°€?

## ğŸ”’ ë³´ì•ˆ ê²€í† 
- [ ] ì»¨í…Œì´ë„ˆê°€ non-rootë¡œ ì‹¤í–‰ë˜ëŠ”ê°€?
- [ ] ë¶ˆí•„ìš”í•œ ê¶Œí•œì´ ì—†ëŠ”ê°€?
- [ ] ì‹œí¬ë¦¿ì´ ì•ˆì „í•˜ê²Œ ê´€ë¦¬ë˜ëŠ”ê°€?
- [ ] ë„¤íŠ¸ì›Œí¬ ì •ì±…ì´ ì ìš©ë˜ì—ˆëŠ”ê°€?

## ğŸ“Š ëª¨ë‹ˆí„°ë§ ì„¤ì •
- [ ] ServiceMonitorê°€ ì„¤ì •ë˜ì—ˆëŠ”ê°€?
- [ ] ì•Œë¦¼ ê·œì¹™ì´ ì •ì˜ë˜ì—ˆëŠ”ê°€?
- [ ] ë¡œê·¸ ìˆ˜ì§‘ì´ ì„¤ì •ë˜ì—ˆëŠ”ê°€?
- [ ] ëŒ€ì‹œë³´ë“œê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ê°€?

## ğŸ”„ ë°±ì—… ë° ë³µêµ¬
- [ ] ë°±ì—… ì •ì±…ì´ ì„¤ì •ë˜ì—ˆëŠ”ê°€?
- [ ] ë³µêµ¬ ì ˆì°¨ê°€ ë¬¸ì„œí™”ë˜ì—ˆëŠ”ê°€?
- [ ] ë°±ì—… í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆëŠ”ê°€?
```

---

> ğŸ’¡ **ì‚¬ìš© íŒ**: ì´ í…œí”Œë¦¿ë“¤ì„ ì‚¬ìš©í•  ë•ŒëŠ” ë³€ìˆ˜ íŒŒì¼ì„ ë³„ë„ë¡œ ê´€ë¦¬í•˜ê³ , envsubstë‚˜ Helm ê°™ì€ ë„êµ¬ë¥¼ í™œìš©í•´ ê°’ì„ ì¹˜í™˜í•˜ì„¸ìš”. ê° í™˜ê²½ë³„ë¡œ ë‹¤ë¥¸ ë³€ìˆ˜ íŒŒì¼ì„ ì‚¬ìš©í•˜ë©´ íš¨ìœ¨ì ì…ë‹ˆë‹¤.

íƒœê·¸: #template #deployment #application #database #monitoring